<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hybrid DDoS IDS - PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; text-align: center; padding: 20px; margin: 0; }
        h1 { color: cyan; }
        #type { font-size: 3em; margin: 20px; }
        button, a.button { padding: 12px 25px; background: #111; color: #0f0; border: 2px solid #0f0; font-size: 1.2em; cursor: pointer; margin: 20px; text-decoration: none; display: inline-block; }
        #packet_list { width: 90%; margin: 30px auto; height: 300px; overflow-y: auto; background: #111; padding: 15px; border: 1px solid #0f0; text-align: left; }
        .packet-entry { padding: 5px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>
    <h1>REAL-TIME DDoS ATTACK TYPE DETECTOR</h1>
    <h2>LIVE ON: <span style="color:lime">http://127.0.0.1:8000 (Local)</span></h2>
    <h2 id="type">Waiting for traffic...</h2>
    <h3>Attacker IP: <span id="ip" style="color:orange">None</span></h3>
    <h3>Detection Time: Capture <span id="capture">0</span> ms | Analysis <span id="analysis">0</span> ms | Total <span id="total">0</span> ms</h3>
    <button onclick="window.open('/details','_blank')">View Details</button>
    <a href="/download_packets" class="button" download>Download Captured Packets</a>
    <canvas id="chart" width="1200" height="500"></canvas>
    <h2>Live Captured Packets</h2>
    <pre id="packet_list"></pre>

    <script>
        const API = "http://127.0.0.1:8000";  // ← ALWAYS LOCAL — WORKS ON ANY NETWORK!

        let token = "";

        const chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Packets/s', borderColor: 'lime', data: [] },
                { label: 'SYN/s', borderColor: 'red', data: [] }
            ]},
            options: { animation: false, scales: { y: { beginAtZero: true } }}
        });

        async function login() {
            const res = await fetch(API + "/login", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({user:"demo",pwd:"demo123"})});
            token = (await res.json()).token;
            setInterval(update, 800);
            setInterval(updatePackets, 1000);
        }

        async function update() {
            if (!token) return;
            try {
                const j = await (await fetch(API + "/detect", {headers:{"Authorization":"Bearer "+token}})).json();
                document.getElementById("type").innerHTML = `<b style="color:${j.result==='ALERT: Attack Detected'?'red':'lime'}">${j.attack_type}</b>`;
                document.getElementById("ip").innerText = j.attacker_ip || "None";

                // Latency
                document.getElementById("capture").innerText = j.capture_time_ms || 0;
                document.getElementById("analysis").innerText = j.analysis_time_ms || 0;
                document.getElementById("total").innerText = j.total_detection_time_ms || 0;

                const time = new Date().toLocaleTimeString().slice(0,-3);
                chart.data.labels.push(time);
                chart.data.datasets[0].data.push(j.pkt_rate || 0);
                chart.data.datasets[1].data.push(j.syn_rate || 0);
                if (chart.data.labels.length > 50) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }
                chart.update();
            } catch(e) {}
        }

        async function updatePackets() {
            try {
                const res = await fetch(API + "/packets", {headers:{"Authorization":"Bearer "+token}});
                const packets = await res.json();
                const list = document.getElementById("packet_list");
                list.innerHTML = '';
                packets.forEach(pkt => {
                    const div = document.createElement("div");
                    div.className = "packet-entry";
                    div.innerHTML = `${pkt.timestamp} → ${pkt.source_ip} → ${pkt.dest_ip} | ${pkt.protocol} | ${pkt.size} bytes | Flags: ${pkt.flags}`;
                    list.appendChild(div);
                });
            } catch(e) {}
        }

        login();
    </script>
</body>
</html>
